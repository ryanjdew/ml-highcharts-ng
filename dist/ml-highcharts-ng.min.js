!function(){"use strict";angular.module("ml.highcharts",["highcharts-ng","ml.common","ml.highcharts.tpls","ml.search","ui.bootstrap"])}(),function(){"use strict";angular.module("ml.highcharts").controller("EditChartConfigCtrl",["$uibModalInstance","$scope","$timeout","HighchartsHelper","facets","highchartConfig","mlSearch",function(e,t,n,a,i,r,s){t.axisTypes=["linear","logarithmic","datetime","categories"],t.facetSortOptions={clone:!0,accept:function(e,t){return!0},allowDuplicates:!1},t.xSortOptions={accept:function(e,t){return t.modelValue&&t.modelValue.length<1}},t.mlSearch=s,t.chartFacetOptions=Object.keys(i);var o=t.chartFacetOptions[0];t.chartFacetOptions.push("$frequency"),t.aggregateTypes=a.aggregateTypes(),t.facets=i,t.highchartConfig=r||{options:{chart:{type:"bar"},tooltip:{style:{padding:10,fontWeight:"bold"}}},title:{text:"Title"},xAxis:{title:{text:o},type:"linear"},seriesNameMLConstraint:o,dataPointNameMLConstraint:null,xAxisMLConstraint:null,xAxisMLConstraintAggregate:null,xAxisCategoriesMLConstraint:null,xAxisCategoriesMLConstraintAggregate:null,yAxis:{title:{text:null},type:"linear"},yAxisMLConstraint:"$frequency",yAxisMLConstraintAggregate:null,zAxis:{title:{text:null},type:"linear"},zAxisMLConstraint:null,zAxisMLConstraintAggregate:null,size:{height:250},resultLimit:15},t.highchartConfig.xAxis||(t.highchartConfig.xAxis={title:{text:null}}),t.highchartConfig.yAxis||(t.highchartConfig.yAxis={title:{text:null}}),t.dataPointNameMLConstraint=_.without([t.highchartConfig.dataPointNameMLConstraint],null,void 0),t.seriesNameMLConstraint=_.without([t.highchartConfig.seriesNameMLConstraint],null,void 0),t.xAxisMLConstraint=_.without([t.highchartConfig.xAxisMLConstraint],null,void 0),t.xAxisCategoriesMLConstraint=_.without([t.highchartConfig.xAxisCategoriesMLConstraint],null,void 0),t.yAxisMLConstraint=_.without([t.highchartConfig.yAxisMLConstraint],null,void 0),t.zAxisMLConstraint=_.without([t.highchartConfig.zAxisMLConstraint],null,void 0);var u=function(){t.highchartConfig.series&&(t.highchartConfig.series.length=0),t.highchartConfig.xAxis.categories&&(t.highchartConfig.xAxis.categories.length=0,t.highchartConfig.xAxis.categories=void 0),t.reset=!0,n(function(){t.reset=!1,t.mlSearch.search()})};t.chartTypes=a.chartTypes(),u(),t.$watch(function(){return t.highchartConfig.options.chart.type+t.highchartConfig.xAxis.title.text+t.highchartConfig.yAxis.title.text+t.highchartConfig.title.text+t.highchartConfig.resultLimit},function(){u()}),t.$watch(function(){return t.xAxisMLConstraint.length+""+t.yAxisMLConstraint.length+t.zAxisMLConstraint.length+t.xAxisCategoriesMLConstraint.length+t.seriesNameMLConstraint.length+t.dataPointNameMLConstraint.length+t.highchartConfig.xAxisMLConstraintAggregate+t.highchartConfig.yAxisMLConstraintAggregate+t.highchartConfig.zAxisMLConstraintAggregate},function(){t.highchartConfig.seriesNameMLConstraint=t.seriesNameMLConstraint[0],t.highchartConfig.dataPointNameMLConstraint=t.dataPointNameMLConstraint[0],t.highchartConfig.xAxisMLConstraint=t.xAxisMLConstraint[0],t.highchartConfig.yAxisMLConstraint=t.yAxisMLConstraint[0],t.highchartConfig.zAxisMLConstraint=t.zAxisMLConstraint[0],t.highchartConfig.xAxisCategoriesMLConstraint=t.xAxisCategoriesMLConstraint[0],u()}),t.save=function(){e.close(t.highchartConfig)}}]).factory("EditChartConfigDialog",["$uibModal","MLSearchFactory",function(e,t){return function(n,a,i){return e.open({templateUrl:"/ml-highcharts/templates/ml-highchart-config-modal.html",controller:"EditChartConfigCtrl",size:"lg",resolve:{facets:function(){return n},highchartConfig:function(){return a},mlSearch:function(){return t.newContext({queryOptions:i||"all"})}}}).result}}])}(),function(){"use strict";angular.module("ml.highcharts").filter("decodeString",function(){return function(e){try{return decodeURIComponent(e)}catch(t){return{}}}}).directive("mlHighchart",["$q","$timeout","HighchartsHelper","MLRest","MLSearchFactory",function(e,t,n,a,i){function r(e,a,r){r.callback||(e.callback=null),e.mlSearch||(e.mlSearch=i.newContext());var s=e.mlSearch;e.structuredQuery&&(s=i.newContext(),s.addAdditionalQuery(e.structuredQuery));var o=function(){e.highchartConfig&&n.chartFromConfig(e.highchartConfig,s,e.callback).then(function(n){t(function(){e.populatedConfig=n})})},u=function(e){return function(){var t=e.apply(this,arguments);return t&&angular.isFunction(t.then)?t.then(function(e){return o(),e}):(o(),t)}},c=s.search;s.search=u(c);var g=null,l=null;e.$watch("highchartConfig",function(t,n){t&&!angular.equals({},t)&&(r.structuredQuery&&!g?g=e.$watch("structuredQuery",function(e){e&&!angular.equals({},e)&&o()},!0):r.mlSearch&&!l?l=e.$watch("mlSearch.results",function(e){e&&!angular.equals({},e)&&o()},!0):(n||!r.mlSearch&&!r.structuredQuery)&&o())},!0)}return{restrict:"E",templateUrl:"/ml-highcharts/templates/ml-highchart.html",scope:{mlSearch:"=?",structuredQuery:"=?",highchartConfig:"=",callback:"&"},link:r}}])}(),function(){"use strict";angular.module("ml.highcharts").factory("HighchartsHelper",["$q","MLQueryBuilder","MLRest","MLSearchFactory",function(e,t,n,a){function i(e){var t=e.options.queryOptions;return x[t]||(x[t]=e.getStoredOptions(t)),x[t]}function r(e){var t;if(/^[1-9]+\/[1-9]+\/[0-9]{2,2}/.test(e)){var n=parseInt(e.replace(/^.*\/([0-9]{2,2})$/,"$1"),10),a=parseInt(e.replace(/^([0-9]{1,2})\/.*$/,"$1"),10);t=new Date(Date.parse(e)),t.setFullYear((n>50?1900:2e3)+n),t.setMonth(a-1)}else if(/^[1-9]+-[A-Za-z]/.test(e)){var i=2e3+parseInt(e.replace(/^([1-9]+)\-(.*)$/,"$1"),10);t=new Date(Date.parse(e)),t.setFullYear(i)}else t=new Date(Date.parse(e));return t}function s(e,t,n){var a={xCategoryAxis:e.xAxisCategoriesMLConstraint,xAxis:e.xAxisMLConstraint,yCategoryAxis:e.yAxisCategoriesMLConstraint,yAxis:e.yAxisMLConstraint,zAxis:e.zAxisMLConstraint,seriesName:e.seriesNameMLConstraint,dataPointName:e.dataPointNameMLConstraint,xCategoryAxisAggregate:e.xAxisCategoriesMLConstraintAggregate,xAxisAggregate:e.xAxisMLConstraintAggregate,yCategoryAxisAggregate:e.yAxisCategoriesMLConstraintAggregate,yAxisAggregate:e.yAxisMLConstraintAggregate,zAxisAggregate:e.zAxisMLConstraintAggregate};a.aggregates={},angular.forEach(a,function(e,t){e&&a[t+"Aggregate"]&&(a.aggregates[e]||(a.aggregates[e]=[]),a.aggregates[e].push({type:a[t+"Aggregate"],axis:t.substring(0,t.indexOf("Axis"))}))});var i=_.map(a.aggregates,function(e,t){return t});return n=_.filter(n,function(e){return i.indexOf(e)<0}),"$frequency"===e.xAxisCategoriesMLConstraint?a.frequency="xCategory":"$frequency"===e.xAxisMLConstraint?a.frequency="x":"$frequency"===e.yAxisCategoriesMLConstraint?a.frequency="yCategory":"$frequency"===e.yAxisMLConstraint?a.frequency="y":"$frequency"===e.zAxisMLConstraint&&(a.frequency="z"),a.facets={xCategoryAxisIndex:t.indexOf(a.xCategoryAxis),xAxisIndex:t.indexOf(a.xAxis),yCategoryAxisIndex:t.indexOf(a.yCategoryAxis),yAxisIndex:t.indexOf(a.yAxis),zAxisIndex:t.indexOf(a.zAxis),seriesNameIndex:t.indexOf(a.seriesName),dataPointNameIndex:t.indexOf(a.dataPointName)},a.values={xCategoryAxisIndex:n.indexOf(a.xCategoryAxis),xAxisIndex:n.indexOf(a.xAxis),yCategoryAxisIndex:n.indexOf(a.yCategoryAxis),yAxisIndex:n.indexOf(a.yAxis),zAxisIndex:n.indexOf(a.zAxis),seriesNameIndex:n.indexOf(a.seriesName),dataPointNameIndex:n.indexOf(a.dataPointName)},a}function o(e,t){return _.filter(e,function(e){return e&&e.name&&t.indexOf(e.name)>-1}).sort(function(e,n){var a=e.collection?1:100,i=n.collection?1:100;return t.indexOf(e.name)*a-t.indexOf(n.name)*i})}function u(e,t,n,a,i){var r=_.map(n,function(e){return e.range}),s=_.map(n,function(e){return e.collection}),o=[{name:"cooccurrence",collection:_.without(s,null,void 0),range:_.without(r,null,void 0),"values-option":["frequency-order","limit="+(a?a:"20")]}],u=e?angular.copy(e.getQuery().query):{queries:[]};i&&i.length&&u.queries.unshift.apply(u.queries,i);var c=e&&e.getText(),g={search:{options:{constraint:t},query:u,qtext:c||""}};return n.length>1?g.search.options.tuples=o:1===n.length&&(g.search.options.values=o),g}function c(e){if(1===e.length)return _.map(e[0].facetValues,function(t){return[{facetName:e[0].name,type:e[0].type,_value:t.value,frequency:t.frequency||t.count,query:{qtext:'"'+e[0].name+'":"'+t.name+'"'}}]});for(var t=[],n=c(e.slice(1)),a=0;a<n.length;a++)for(var i=0;i<e[0].facetValues.length;i++)t.push(_.flatten([{facetName:e[0].name,type:e[0].type,_value:e[0].facetValues[i].value,frequecy:e[0].facetValues[i].frequency,query:g(e[0].name,e[0].facetValues[i].name)},n[a]]));return t}function g(e,t){return{qtext:'"'+e+'":"'+t+'"'}}var l={},x={};return l.seriesData=function(e,t,n,a,i){var r=[];return angular.forEach(e,function(e){var t;if(e.seriesName?(t=_.filter(r,function(t){return t.name===e.seriesName})[0],t||(t={name:e.seriesName,data:[]},r.push(t))):t=r[0],t||(t={name:e.facetNames.join(" - "),data:[]},r.push(t)),e.xCategory){var a=n.indexOf(e.xCategory);t.data[a]=e}else t.data.push(e)}),angular.forEach(r,function(e){(n&&n.length||a&&a.length)&&(angular.forEach(e.data,function(e){e.xCategory&&void 0===e.x&&(e.x=n.indexOf(e.xCategory)),e.yCategory&&void 0===e.y&&(e.y=a.indexOf(e.yCategory))}),angular.forEach(n,function(t,n){e.data[n]||(e.data[n]={})})),e.data.sort(function(e,t){return t.x-e.x})}),r},l.chartFromConfig=function(t,n,r){var s=e.defer(),o=t.options.chart.type,u=angular.copy(t);if(n||(n=a.newContext()),r){var c={series:{cursor:"pointer",point:{events:{click:function(){var e=this.name||this.seriesName;r(angular.extend({facet:this.facetNames[0],value:e},this))}}}}};u.options.plotOptions?angular.merge(u.options.plotOptions,c):u.options.plotOptions=c}return i(n).then(function(e){e.options&&e.options.constraint&&e.options.constraint.length&&l.getChartData(n,e.options.constraint,t,t.resultLimit).then(function(e){u.series=l.seriesData(e.data,o,e.categories,e.yCategories,t),e.categories&&e.categories.length&&(u.xAxis.type="category",u.xAxis.categories=e.categories,u.xAxis.min=0,u.xAxis.max=u.xAxis.categories.length-1,"bubble"===u.options.chart.type&&(u.xAxis.categories.unshift(""),u.xAxis.categories.push(""),u.xAxis.max=u.xAxis.max+2,angular.forEach(u.series,function(e){angular.forEach(e.data,function(e){e.xCategory&&(e.x=e.x+1)})}))),e.yCategories&&e.yCategories.length&&(u.yAxis.type="category",u.yAxis.categories=e.yCategories,"bubble"===u.options.chart.type&&(u.yAxis.categories.unshift(""),u.yAxis.categories.push(""),angular.forEach(u.series,function(e){angular.forEach(e.data,function(e){e.yCategory&&(e.y=e.y+1)})}))),u.legend=u.legend||{},u.legend.enabled=void 0!==u.legend.enabled?u.legend.enabled:u.series.length>1,s.resolve(u)})}),s.promise},l.getChartData=function(t,a,i,x){var h,f=_.without([i.seriesNameMLConstraint,i.dataPointNameMLConstraint,i.xAxisCategoriesMLConstraint,i.xAxisMLConstraint,i.yAxisCategoriesMLConstraint,i.yAxisMLConstraint,i.zAxisMLConstraint],null,void 0,"$frequency"),y=i.xAxis&&"datetime"===i.xAxis.type,C=i.yAxis&&"datetime"===i.yAxis.type,d=i.zAxis&&"datetime"===i.zAxis.type,m=[],A=[],p=[];if(t.results.facets){var v=angular.copy(t.results.facets);angular.forEach(v,function(e,t){e.name=t}),h=e.when(v)}else h=n.search({options:t.options.queryOptions}).then(function(e){return angular.forEach(e.data.facets,function(e,t){e.name=t}),e.data.facets});return h.then(function(h){if(a&&a.length){var v=o(a,f),L=[],M=[];angular.forEach(v,function(e){e.custom||e.range&&(e.range.bucket||e.range["computed-bucket"])?L.push(h[e.name]):M.push(e)});var q,N=_.map(M,function(e){return e.name}),I=_.map(L,function(e){return e.name}),O=s(i,I,N),w=function(e,t){var n=e?e._value:void 0;return t&&n?r(n):n};if(q=L.length>0?c(L):[[]],M.length>0){var z=[],b=_.filter(M,function(e){return!O.aggregates[e.name]}),$=_.filter(M,function(e){return O.aggregates[e.name]});return angular.forEach(q,function(e){var n=_.map(e,function(e){return e.query});b.length>0&&z.push(l.constraintValueCall(t,a,b,x,n).then(function(t){t["values-response"]&&(b.length>1?angular.forEach(t["values-response"].tuple,function(t){var n=t["distinct-value"],a={facetNames:f,seriesName:w(_.without([n[O.values.seriesNameIndex],e[O.facets.seriesNameIndex]],null,void 0)[0]),name:w(_.without([n[O.values.dataPointNameIndex],e[O.facets.dataPointNameIndex]],null,void 0)[0]),xCategory:w(_.without([n[O.values.xCategoryAxisIndex],e[O.facets.xCategoryAxisIndex]],null,void 0)[0]),x:w(_.without([n[O.values.xAxisIndex],e[O.facets.xAxisIndex]],null,void 0)[0],y),yCategory:w(_.without([n[O.values.yCategoryAxisIndex],e[O.facets.yCategoryAxisIndex]],null,void 0)[0]),y:w(_.without([n[O.values.yAxisIndex],e[O.facets.yAxisIndex]],null,void 0)[0],C),z:w(_.without([n[O.values.zAxisIndex],e[O.facets.zAxisIndex]],null,void 0)[0],d)};a.xCategory&&m.indexOf(a.xCategory)<0&&m.push(a.xCategory),a.yCategory&&A.indexOf(a.yCategory)<0&&A.push(a.yCategory),a.name||(a.name=_.without([a.seriesName,a.xCategory,a.x,a.yCategory,a.y,a.z],null,void 0).join()),a[O.frequency]=t.frequency,a.frequency=t.frequency,p.push(a)}):angular.forEach(t["values-response"]["distinct-value"],function(t){var n={facetNames:f,seriesName:w(_.without([O.values.seriesNameIndex>-1?t:null,e[O.facets.seriesNameIndex]],null,void 0)[0]),name:w(_.without([O.values.dataPointNameIndex>-1?t:null,e[O.facets.dataPointNameIndex]],null,void 0)[0]),xCategory:w(_.without([O.values.xCategoryAxisIndex>-1?t:null,e[O.facets.xCategoryAxisIndex]],null,void 0)[0]),x:w(_.without([O.values.xAxisIndex>-1?t:null,e[O.facets.xAxisIndex]],null,void 0)[0],y),yCategory:w(_.without([O.values.yCategoryAxisIndex>-1?t:null,e[O.facets.yCategoryAxisIndex]],null,void 0)[0]),y:w(_.without([O.values.yAxisIndex>-1?t:null,e[O.facets.yAxisIndex]],null,void 0)[0],C),z:w(_.without([O.values.zAxisIndex>-1?t:null,e[O.facets.zAxisIndex]],null,void 0)[0],d)};n.xCategory&&m.indexOf(n.xCategory)<0&&m.push(n.xCategory),n.yCategory&&A.indexOf(n.yCategory)<0&&A.push(n.yCategory),n.name||(n.name=_.without([n.xCategory,n.x,n.yCategory,n.y,n.z],null,void 0).join()),n[O.frequency]=t.frequency,n.frequency=t.frequency,p.push(n)}))}))}),e.all(z).then(function(){var n=[];return angular.forEach($,function(e){angular.forEach(O.aggregates[e.name],function(i){angular.forEach(p,function(r){var s=_.without(_.map(r,function(e,t){var n=O[t+"Axis"];return"name"===t?n=O.dataPointName:"seriesName"===t&&(n=O.seriesName),e&&n&&"$frequency"!==n?g(n,e):null}),null,void 0);n.push(l.constraintValueCall(t,a,[e],x,s,i.type).then(function(e){r[i.axis]=Number(e["values-response"]["aggregate-result"][0]._value)}))})})}),e.all(n).then(function(){return{data:p.sort(function(e,t){return t.frequency-e.frequency}),categories:m,yCategories:A}})})}var E=[];return angular.forEach(q,function(e,i){var r={facetNames:f,seriesName:w(e[O.facets.seriesNameIndex]),name:w(e[O.facets.dataPointNameIndex]),xCategory:w(e[O.facets.xCategoryAxisIndex]),x:w(e[O.facets.xAxisIndex],y),yCategory:w(e[O.facets.yCategoryAxisIndex]),y:w(e[O.facets.yAxisIndex],C),z:w(e[O.facets.zAxisIndex],d)};if(r.xCategory&&m.indexOf(r.xCategory)<0&&m.push(r.xCategory),r.yCategory&&A.indexOf(r.yCategory)<0&&A.push(r.yCategory),1===L.length)r.frequency=e[0].frequency||e[0].count,r[O.frequency]=r.frequency;else{var s=_.map(e,function(e){return e.query}),o=u(t,a,[],x,s);o.search.options["return-results"]=!1,o.search.options["return-facets"]=!1,o.search.options["return-values"]=!1,o.search.options["return-metrics"]=!0,E.push(n.search({options:t.options.queryOptions},o).then(function(e){var t=e.data.total;r.frequency=t,r[O.frequency]=t}))}p.push(r)}),e.all(E).then(function(){return{data:p.sort(function(e,t){return t.frequency-e.frequency}),categories:m}})}})},l.constraintValueCall=function(e,t,a,i,r,s){var o=u(e,t,a,i,r);return n.values("cooccurrence",{format:"json",aggregate:s,view:s?"aggregate":"all"},o).then(function(e){return e.data})},l.chartTypes=function(){return["line","spline","area","areaspline","column","bar","bubble","pie","scatter"]},l.aggregateTypes=function(){return[null,"sum","avg","min","max","median","count","stddev","stddev-population","correlation","covariance","covariance-population","variance","variance-population"]},l}])}();